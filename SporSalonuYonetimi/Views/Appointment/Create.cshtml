@model SporSalonuYonetimi.Models.Appointment

@{
    ViewData["Title"] = "Randevu Al";
    var serviceName = ViewBag.ServiceName;
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4>ðŸ“… @serviceName Ä°Ã§in Randevu OluÅŸtur</h4>
                </div>
                <div class="card-body">
                    <form asp-action="Create" id="bookingForm">
                        <input type="hidden" asp-for="ServiceId" value="@ViewBag.ServiceId" />
                        
                        <div class="form-group mb-4">
                            <label class="fw-bold">AntrenÃ¶r SeÃ§iniz:</label>
                            <select asp-for="TrainerId" class="form-control" asp-items="ViewBag.Trainers" id="trainerSelect">
                                <option value="">-- LÃ¼tfen Ã–nce AntrenÃ¶r SeÃ§in --</option>
                            </select>
                        </div>

                        <div class="form-group mb-4">
                            <label class="fw-bold">Tarih SeÃ§iniz:</label>
                            <input asp-for="AppointmentDate" type="date" class="form-control" id="dateSelect" 
                                   min="@DateTime.Now.ToString("yyyy-MM-dd")" /> </div>

                        <div class="form-group mb-4">
                            <label class="fw-bold d-block">MÃ¼sait Saatler:</label>
                            <div id="timeSlots" class="d-flex flex-wrap gap-2">
                                <span class="text-muted small">LÃ¼tfen Ã¶nce antrenÃ¶r ve tarih seÃ§iniz.</span>
                            </div>
                            <input type="hidden" name="SelectedTime" id="selectedTimeInput" />
                        </div>

                        <button type="submit" class="btn btn-success w-100 btn-lg" id="submitBtn" disabled>
                            Randevuyu Onayla
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // AntrenÃ¶r veya Tarih deÄŸiÅŸirse Ã§alÄ±ÅŸÄ±r
        $('#trainerSelect, #dateSelect').change(function () {
            var trainerId = $('#trainerSelect').val();
            var date = $('#dateSelect').val();
            var slotsDiv = $('#timeSlots');
            var submitBtn = $('#submitBtn');

            // EÄŸer ikisi de seÃ§iliyse sorgu yap
            if (trainerId && date) {
                slotsDiv.html('<div class="spinner-border text-primary" role="status"><span class="visually-hidden">YÃ¼kleniyor...</span></div> Saatler kontrol ediliyor...');
                
                // Backend'deki GetAvailableHours metoduna git
                $.ajax({
                    url: '/Appointment/GetAvailableHours',
                    data: { trainerId: trainerId, date: date },
                    success: function (data) {
                        slotsDiv.empty(); // Eski saatleri temizle

                        if (data.message) {
                            slotsDiv.html('<div class="alert alert-warning">' + data.message + '</div>');
                        } 
                        else if (data.length === 0) {
                            slotsDiv.html('<div class="alert alert-danger">Maalesef bu tarihte uygun saat yok.</div>');
                        } 
                        else {
                            // Gelen saatleri buton olarak ekrana bas
                            $.each(data, function (index, time) {
                                var btn = $('<button type="button" class="btn btn-outline-primary time-slot">' + time + '</button>');
                                
                                // Saate tÄ±klayÄ±nca ne olsun?
                                btn.click(function () {
                                    // DiÄŸer butonlarÄ±n rengini normale dÃ¶ndÃ¼r
                                    $('.time-slot').removeClass('btn-primary').addClass('btn-outline-primary');
                                    // TÄ±klananÄ± mavi yap
                                    $(this).removeClass('btn-outline-primary').addClass('btn-primary');
                                    
                                    // Gizli inputa saati yaz (Ã–rn: 14:00)
                                    // Backend'de bunu tarihle birleÅŸtireceÄŸiz
                                    $('#selectedTimeInput').val(time);
                                    
                                    // Kaydet butonunu aktif et
                                    submitBtn.prop('disabled', false);
                                });
                                
                                slotsDiv.append(btn);
                            });
                        }
                    }
                });
            }
        });
    </script>
}