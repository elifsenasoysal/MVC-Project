@model SporSalonuYonetimi.Models.Appointment

@{
    ViewData["Title"] = "Randevu Al";
    var serviceName = ViewBag.ServiceName;
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4>ðŸ“… @serviceName Ä°Ã§in Randevu OluÅŸtur</h4>
                </div>
                <div class="card-body">
                    <form asp-action="Create" id="bookingForm">
                        <input type="hidden" asp-for="ServiceId" value="@ViewBag.ServiceId" />

                        <div class="form-group mb-4">
                            <label class="fw-bold">AntrenÃ¶r SeÃ§iniz:</label>
                            <select asp-for="TrainerId" class="form-control" asp-items="ViewBag.Trainers"
                                id="trainerSelect">
                                <option value="">-- LÃ¼tfen Ã–nce AntrenÃ¶r SeÃ§in --</option>
                            </select>
                        </div>

                        <div class="form-group mb-4">
                            <label class="fw-bold">Tarih SeÃ§iniz:</label>
                            <input asp-for="AppointmentDate" type="date" class="form-control" id="dateSelect"
                                min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                        </div>

                        <div class="form-group mb-4">
                            <label class="fw-bold d-block">MÃ¼sait Saatler:</label>
                            <div id="timeSlots" class="d-flex flex-wrap gap-2">
                                <span class="text-muted small">LÃ¼tfen Ã¶nce antrenÃ¶r ve tarih seÃ§iniz.</span>
                            </div>
                            <input type="hidden" name="SelectedTime" id="selectedTimeInput" />
                        </div>

                        <button type="submit" class="btn btn-success w-100 btn-lg" id="submitBtn" disabled>
                            Randevuyu Onayla
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function ()
        {

            // AntrenÃ¶r veya Tarih deÄŸiÅŸirse Ã§alÄ±ÅŸÄ±r
            $('#trainerSelect, #dateSelect').change(function ()
            {
                var trainerId = $('#trainerSelect').val();
                var date = $('#dateSelect').val();
                var slotsDiv = $('#timeSlots');
                var submitBtn = $('#submitBtn');
                var selectedTimeInput = $('#selectedTimeInput');

                // Ã–nce temizle ve butonu pasif yap
                slotsDiv.empty();
                selectedTimeInput.val('');
                submitBtn.prop('disabled', true);

                // EÄŸer ikisi de seÃ§iliyse sorgu yap
                if (trainerId && date)
                {
                    slotsDiv.html('<div class="spinner-border text-primary" role="status"><span class="visually-hidden">YÃ¼kleniyor...</span></div> <span class="text-muted">Saatler kontrol ediliyor...</span>');

                    $.ajax({
                        url: '/api/ajax/check-hours', // API Adresimiz
                        type: 'GET',
                        data: { trainerId: trainerId, date: date },
                        success: function (data)
                        {
                            slotsDiv.empty();

                            if (data.length === 0)
                            {
                                slotsDiv.html('<div class="alert alert-warning">Bu tarih iÃ§in uygun Ã§alÄ±ÅŸma saati bulunamadÄ± veya salon kapalÄ±.</div>');
                            }
                            else
                            {
                                // Gelen veriyi dÃ¶ngÃ¼ye al (item.time ve item.isFull)
                                $.each(data, function (index, item)
                                {

                                    var btnClass = item.isFull ? 'btn-danger' : 'btn-outline-success';
                                    var disabledAttr = item.isFull ? 'disabled' : '';
                                    var buttonText = item.time;

                                    // Doluysa yanÄ±na yazalÄ±m
                                    if (item.isFull)
                                    {
                                        buttonText += ' (Dolu)';
                                        btnClass = 'btn-secondary';
                                    }

                                    // Butonu oluÅŸtur
                                    var btn = $('<button type="button" class="btn ' + btnClass + ' time-slot m-1" ' + disabledAttr + '>' + buttonText + '</button>');

                                    // Sadece boÅŸ olanlara tÄ±klanÄ±nca Ã§alÄ±ÅŸsÄ±n
                                    if (!item.isFull)
                                    {
                                        btn.click(function ()
                                        {
                                            // DiÄŸer butonlarÄ±n rengini sÄ±fÄ±rla
                                            $('.time-slot').not(':disabled').removeClass('btn-success').addClass('btn-outline-success');

                                            // TÄ±klananÄ± seÃ§ili yap
                                            $(this).removeClass('btn-outline-success').addClass('btn-success');

                                            // Gizli inputa saati yaz
                                            selectedTimeInput.val(item.time);

                                            // Kaydet butonunu aktif et
                                            submitBtn.prop('disabled', false);
                                        });
                                    }

                                    slotsDiv.append(btn);
                                });
                            }
                        },
                        error: function (xhr, status, error)
                        {
                            // Ekrana hatanÄ±n detayÄ±nÄ± basÄ±yoruz
                            var errorMsg = "Hata Kodu: " + xhr.status + " - " + xhr.statusText;
                            slotsDiv.html('<div class="alert alert-danger">Bir sorun oluÅŸtu: ' + errorMsg + '</div>');
                            console.log(xhr.responseText); // DetayÄ± konsola yaz
                        }
                    });
                }
            });
        });
    </script>
}